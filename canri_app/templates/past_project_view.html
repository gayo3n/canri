{% extends 'base.html' %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/past_project_view.css' %}">
{% endblock %}
{% block content %}

<main class="main-content">
    <div class="split-container">
        <!-- チームセクション -->
        <section class="teams-section">
            <div class="container">
                <h3>関連チーム</h3>
                <div class="teams-grid">
                    {% for affiliation in teams %}
                        <div class="team-card">
                            <a href="チーム詳細リンク">{{ affiliation.team.team_name }}</a>
                        </div>
                    {% endfor %}
                </div>  
            </div>
        </section>

        <!-- プロジェクト詳細セクション -->
        <section class="project-section">
            <!--プロジェクト情報-->
            <div class="project-list">
                <div class="project-card">
                    <input type="hidden" name="project_id" value="{{ project.project_id }}">
                    <h1>{{ project.project_name }}</h1>
                    <p>開始日: {{ project.creation_date|date:"Y年m月d日" }}</p>
                    <p>完了日: {{ project.complete_date|date:"Y年m月d日" }}</p>
                    <p>プロジェクト詳細: {{ project.project_detail }}</p>
                    <p>事後評価メモ: {{ project.post_evaluation_memo }}</p>
                    <button class="feedbackbutton" onclick="openAddFeedback()">フィードバック</button>
                    <button class="delete-button">削除</button>
                    <button class="action-button">保存</button>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- フィードバックモーダルのHTML -->
<div class="modal" style="display: none;">
    <div class="modal-content" style="width: 70%; max-width: 1000px;">
        <span class="close" onclick="closeFeedbackModal()">&times;</span>
        <div id="modal-body">
            <!-- feedback_application.htmlの内容がここに読み込まれる -->        
        </div>
    </div>
</div>

<!-- フィードバック保存完了モーダルのHTML -->
<div class="modal" id="saveCompleteModal" style="display: none;">
    <div class="modal-content" style="width: 70%; max-width: 1000px;">
        <span class="close" onclick="closeSaveCompleteModal()">&times;</span>
        <div id="save-complete-body">
            <!-- feedback_save_complete.htmlの内容がここに読み込まれる -->
        </div>
    </div>
</div>

<script>
    // フィードバックモーダルを開く
    function openAddFeedback() {
        const projectId = document.querySelector('input[name="project_id"]').value;
        if (!projectId) {
            console.error('Project ID is missing');
            return;
        }

        fetch("{% url 'canri_app:feedback' project_id=0 %}".replace('0', projectId))
            .then(response => response.text())
            .then(html => {
                document.getElementById('modal-body').innerHTML = html;
                document.querySelector('.modal').style.display = 'block';
            })
            .catch(error => console.error('Error loading feedback application:', error));
    }

    // フィードバックモーダルを閉じる
    function closeFeedbackModal() {
        document.querySelector('.modal').style.display = 'none';
    }

    // フィードバック保存完了モーダルを閉じる
    function closeSaveCompleteModal() {
        document.getElementById('saveCompleteModal').style.display = 'none';
    }

    // フィードバックを保存する
    function saveFeedback() {
        fetch("{% url 'canri_app:feedback_save' %}")
        .then(response => response.text())
        .then(html => {
            document.querySelector('.modal').style.display = 'none';
            document.getElementById('save-complete-body').innerHTML = html;
            document.getElementById('saveCompleteModal').style.display = 'block';
        })
        .catch(error => console.error('Error saving feedback:', error));
    }
</script>
{% endblock %}