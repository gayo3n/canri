{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/past_project_view.css' %}">
{% endblock %}

{% block content %}
<main class="main-content">
    <div class="split-container">
        <!-- ãƒãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="teams-section">
            <div class="container">
                <h3>é–¢é€£ãƒãƒ¼ãƒ </h3>
                <div class="teams-grid">
                    {% for team in teams %}
                        <div class="team-card">
                            <a href="{% url 'canri_app:team_edit_past' team_id=team.team_id%}?project_id={{ project.project_id}}">{{ team.team_name }}</a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- å¢ƒç•Œç·š -->
        <div class="vertical-line"></div>

        <!-- å³å´ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="project-section">
            <div class="project-list">
                <form method="post" action="{% url 'canri_app:past_project_view' project_id=project.project_id %}">
                    {% csrf_token %}
                    <input type="hidden" name="project_id" value="{{ project.project_id }}">
                    <h1>{{ project.project_name }}</h1>
                    <div class="horizontal-line"></div>
                    <p>é–‹å§‹æ—¥ï¼š{{ project_start_date|date:"Yå¹´mæœˆdæ—¥" }}</p>
                    <p>å®Œäº†æ—¥ï¼š{{ project_end_date|date:"Yå¹´mæœˆdæ—¥" }}</p>
                    <label for="post_evaluation_memo">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ï¼š</label>
                    <p>&emsp;&emsp;{{ project.project_detail }}</p>
                    <label for="post_evaluation_memo">äº‹å¾Œè©•ä¾¡ãƒ¡ãƒ¢</label>
                    <textarea id="post_evaluation_memo" name="post_evaluation_memo" rows="15" style="width: 100%; margin-bottom: 20px;">{{ project.post_evaluation_memo }}</textarea>
                    <div class="button-container">
                        <button type="button" class="feedbackbutton" onclick="openAddFeedback()">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
                        <button type="button" class="delete-button" onclick="openDeleteModal()">å‰Šé™¤</button>
                        <button type="submit" class="action-button">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </section>
    </div>
</main>

<!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" style="display: none;">
    <div class="modal-content" style="width: 70%; max-width: 1000px;">
        <span class="close" onclick="closeFeedbackModal()">&times;</span>
        <div id="modal-body">
            <div class="feedback-form">
                <h2>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®åæ˜ </h2>
                <table border="1">
                    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒŠ -->
                    <div id="feedback-container">
                        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡Œã¯JavaScriptã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                </table>
                <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <button class="add-feedback" type="button" onclick="addFeedbackRow()">ï¼‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¿½åŠ </button>
                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <button class="btn-save" type="button" onclick="saveFeedback()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="saveCompleteModal" style="display: none;">
    <div class="modal-content" style="width: 70%; height: 30vh; max-width: 1000px;">
        <span class="close" onclick="closeSaveCompleteModal()">&times;</span>
        <div id="save-complete-body">
            <div class="save-complete">
                <h1 style="display: flex; justify-content: center; align-items: center; height: 25vh; text-align: center;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ</h1>
            </div>
        </div>
    </div>
</div>

<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="deleteModal" style="display: none;">
    <div class="modal-content" style="width: 50%; max-width: 600px;">
        <span class="close" onclick="closeDeleteModal()">&times;</span>
        <h2>å‰Šé™¤ç¢ºèª</h2>
        <p>ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
        <form method="post" action="{% url 'canri_app:past_project_view' project_id=project.project_id %}">
            {% csrf_token %}
            <input type="hidden" name="delete" value="1">
            <button type="submit" class="action-button">å‰Šé™¤</button>
        </form>
    </div>
</div>

<script>
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAddFeedback() {
        document.querySelector('.modal').style.display = 'block';
        fetchMembers();
        fetchFeedbacks();
    }

    // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    function fetchMembers() {
        const projectId = document.querySelector('input[name="project_id"]').value;
        fetch("{% url 'canri_app:get_members_by_project' project_id=0 %}".replace('0', projectId))
            .then(response => response.json())
            .then(data => {
                window.members = data.members;
            })
            .catch(error => console.error('Error fetching members:', error));
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    function fetchFeedbacks() {
        const projectId = document.querySelector('input[name="project_id"]').value;
        fetch("{% url 'canri_app:get_feedbacks_by_project' project_id=0 %}".replace('0', projectId))
            .then(response => response.json())
            .then(data => {
                const feedbackContainer = document.getElementById('feedback-container');
                feedbackContainer.innerHTML = ''; // æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡Œã‚’ã‚¯ãƒªã‚¢
                data.feedbacks.forEach(feedback => {
                    const feedbackRow = document.createElement('div');
                    feedbackRow.classList.add('feedback-row', 'existing-feedback');
                    feedbackRow.innerHTML = `
                        <form method="post" class="feedback-form">
                            {% csrf_token %}
                            <input type="hidden" name="feedback_id" value="${feedback.feedback_id}">
                            <select name="member1" title="member1" onchange="validateMembers(this)">
                                ${window.members.map(member => `<option value="${member.member_id}" ${member.member_id == feedback.member1_id ? 'selected' : ''}>${member.name}</option>`).join('')}
                            </select>
                            ã¨
                            <select name="member2" title="member2" onchange="validateMembers(this)">
                                ${window.members.map(member => `<option value="${member.member_id}" ${member.member_id == feedback.member2_id ? 'selected' : ''}>${member.name}</option>`).join('')}
                            </select>
                            ã‚’
                            <select name="priority" title="condition:">
                                <option value="True" ${feedback.priority_flag ? 'selected' : ''}>å„ªå…ˆçš„ã«åŒã˜ãƒãƒ¼ãƒ ã«ç·¨æˆã™ã‚‹</option>
                                <option value="False" ${!feedback.priority_flag ? 'selected' : ''}>åŒã˜ãƒãƒ¼ãƒ ã«ç·¨æˆã—ãªã„</option>
                            </select>
                            <button type="button" class="btn btn-danger" onclick="deleteFeedback(${feedback.feedback_id})">ğŸ—‘ï¸</button>
                        </form>
                    `;
                    feedbackContainer.appendChild(feedbackRow);
                });
            })
            .catch(error => console.error('Error fetching feedbacks:', error));
    }



    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡Œã‚’è¿½åŠ ã™ã‚‹
    function addFeedbackRow() {
        const feedbackContainer = document.getElementById('feedback-container');
        const newRow = document.createElement('div');
        newRow.classList.add('feedback-row', 'new-feedback');
        newRow.innerHTML = `
            <form method="post" class="feedback-form">
                {% csrf_token %}
                <select name="member1" title="member1" onchange="validateMembers(this)">
                    <option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>
                    ${window.members.map(member => `<option value="${member.member_id}">${member.name}</option>`).join('')}
                </select>
                ã¨
                <select name="member2" title="member2" onchange="validateMembers(this)">
                    <option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>
                    ${window.members.map(member => `<option value="${member.member_id}">${member.name}</option>`).join('')}
                </select>
                ã‚’
                <select name="priority" title="condition:">
                    <option value="True">å„ªå…ˆçš„ã«åŒã˜ãƒãƒ¼ãƒ ã«ç·¨æˆã™ã‚‹</option>
                    <option value="False">åŒã˜ãƒãƒ¼ãƒ ã«ç·¨æˆã—ãªã„</option>
                </select>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove()">ğŸ—‘ï¸</button>
            </form>
        `;
        feedbackContainer.appendChild(newRow);
    }

    // ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateMembers(selectElement) {
        const form = selectElement.closest('form');
        const member1 = form.querySelector('select[name="member1"]').value;
        const member2 = form.querySelector('select[name="member2"]').value;

        if (member1 === member2) {
            alert('åŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚');
            selectElement.value = '';
        }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeFeedbackModal() {
        document.querySelector('.modal').style.display = 'none';
    }
    function closeSaveCompleteModal() {
        document.getElementById('saveCompleteModal').style.display = 'none';
    }
    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'block';
    }
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¿å­˜ã™ã‚‹
    function saveFeedback() {
        const feedbackContainer = document.getElementById('feedback-container');
        const existingForms = feedbackContainer.querySelectorAll('.existing-feedback .feedback-form');
        const newForms = feedbackContainer.querySelectorAll('.new-feedback .feedback-form');
        const existingFeedbacks = [];
        const newFeedbacks = [];

        let isValid = true;

        existingForms.forEach((form) => {
            const feedbackId = form.querySelector('input[name="feedback_id"]').value;
            const member1 = form.querySelector('select[name="member1"]').value;
            const member2 = form.querySelector('select[name="member2"]').value;
            const priority = form.querySelector('select[name="priority"]').value;

            if (!member1 || !member2) {
                isValid = false;
                alert('ãƒ¡ãƒ³ãƒãƒ¼1ã¨ãƒ¡ãƒ³ãƒãƒ¼2ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            existingFeedbacks.push({ feedback_id: feedbackId, member1, member2, priority });
        });

        newForms.forEach((form) => {
            const member1 = form.querySelector('select[name="member1"]').value;
            const member2 = form.querySelector('select[name="member2"]').value;
            const priority = form.querySelector('select[name="priority"]').value;

            if (!member1 || !member2) {
                isValid = false;
                alert('ãƒ¡ãƒ³ãƒãƒ¼1ã¨ãƒ¡ãƒ³ãƒãƒ¼2ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            newFeedbacks.push({ member1, member2, priority });
        });

        if (!isValid) {
            return;
        }

        const projectId = document.querySelector('input[name="project_id"]').value;
        const data = {
            project_id: projectId,
            existing_feedbacks: existingFeedbacks,
            new_feedbacks: newFeedbacks
        };

        fetch("{% url 'canri_app:feedback_save' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.text())
        .then(html => {
            document.querySelector('.modal').style.display = 'none';
            document.getElementById('save-complete-body').innerHTML = html;
            document.getElementById('saveCompleteModal').style.display = 'block';
        })
        .catch(error => console.error('Error saving feedback:', error));
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤ã™ã‚‹
    function deleteFeedback(feedbackId) {
        fetch("{% url 'canri_app:delete_feedback' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ feedback_id: feedbackId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const form = document.querySelector(`input[value="${feedbackId}"]`).closest('form');
                form.style.display = 'none';
            }
        })
        .catch(error => console.error('Error deleting feedback:', error));
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
