{% extends 'base2.html' %}

{% load custom_filters %} <!-- カスタムフィルターをロード -->

{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/new_project_edit.css' %}">
{% endblock %}

{% block content %}
<div class="main-content">
    <h1>新規プロジェクト作成</h1>
    <p>プロジェクト名: {{ project.project_name }}</p>
    <p>プロジェクトの詳細: {{ project.project_description }}</p>
    <p>開始日: {{ project.start_date }}</p>
    <p>完了予定日: {{ project.end_date }}</p>

    <h2>参加チーム一覧</h2>
    <div id="teamList" class="team-list">
        {% if teams %}
            {% for team_id in teams %}
                <div id="team-{{ team_id }}" class="team-item">チーム情報を取得中...</div>
            {% endfor %}
        {% else %}
            <div id="noTeamsMessage">チームが存在しません</div>
        {% endif %}
    </div>

    <div class="button-container">
        <form method="post" action="{% url 'canri_app:create_team' %}" class="button-form">
            {% csrf_token %}
            <input type="hidden" name="project_name" value="{{ project.project_name }}">
            <input type="hidden" name="project_description" value="{{ project.project_description }}">
            <input type="hidden" name="start_date" value="{{ project.start_date }}">
            <input type="hidden" name="end_date" value="{{ project.end_date }}">
            <input type="hidden" name="teams" value="{{ teams|safe }}">
            <button type="submit" class="action-button back-button">チームを新規で作成</button>
        </form>

        <form id="saveProjectForm" method="post" action="{% url 'canri_app:save_new_project' %}" class="button-form">
            {% csrf_token %}
            <input type="hidden" name="project_name" value="{{ project.project_name }}">
            <input type="hidden" name="project_description" value="{{ project.project_description }}">
            <input type="hidden" name="start_date" value="{{ project.start_date }}">
            <input type="hidden" name="end_date" value="{{ project.end_date }}">
            <input type="hidden" name="teams" value="{{ teams|safe }}">
            <button type="button" class="action-button next-button" onclick="validateAndSubmit()">プロジェクトを保存</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const teamIds = {{ teams|safe }};
        teamIds.forEach(teamId => {
            fetch(`{% url 'canri_app:get_team_data' team_id=0 %}`.replace("0", teamId))
                .then(response => response.json())
                .then(data => {
                    const teamElement = document.getElementById(`team-${teamId}`);
                    if (data.team) {
                        teamElement.textContent = data.team.team_name;
                    } else {
                        teamElement.textContent = 'チーム情報の取得に失敗しました';
                    }
                })
                .catch(error => {
                    const teamElement = document.getElementById(`team-${teamId}`);
                    teamElement.textContent = 'チーム情報の取得に失敗しました';
                    console.error('チーム情報の取得エラー:', error);
                });
        });
    });

    function validateAndSubmit() {
        const noTeamsMessage = document.getElementById('noTeamsMessage');
        if (noTeamsMessage) {
            alert('少なくとも1つのチームを追加してください。');
        } else {
            document.getElementById('saveProjectForm').submit();
        }
    }
</script>
{% endblock %}