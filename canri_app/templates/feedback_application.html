{% load static %} 

{% block head %} 
<link rel="stylesheet" href="{% static 'css/feedback_application.css' %}">
{% endblock %}

{% block content %}

<div class="feedback-form">
    <h2>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®åæ˜ </h2>
    <table border="1">
        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="feedback-container">
            {% for feedback in feedbacks %}
            <!-- åˆæœŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡Œ -->
            <div class="feedback-row">
                <form method="post" class="feedback-form">
                    {% csrf_token %}
                    <input type="hidden" name="feedback_id" value="{{ feedback.feedback_id }}">
                    <select name="member1" title="member1" onchange="validateMembers(this)">
                        {% for member in members %}
                        <option value="{{ member.member_id }}" {% if member.member_id == feedback.member1_id %}selected{% endif %}>{{ member.name }}</option>
                        {% endfor %}
                    </select>
                    ã¨
                    <select name="member2" title="member2" onchange="validateMembers(this)">
                        {% for member in members %}
                        <option value="{{ member.member_id }}" {% if member.member_id == feedback.member2_id %}selected{% endif %}>{{ member.name }}</option>
                        {% endfor %}
                    </select>
                    ã‚’
                    <select name="priority" title="condition:">
                        <option value="True" {% if feedback.priority_flag %}selected{% endif %}>å„ªå…ˆçš„ã«åŒã˜ãƒãƒ¼ãƒ ã«ç·¨æˆã™ã‚‹</option>
                        <option value="False" {% if not feedback.priority_flag %}selected{% endif %}>åŒã˜ãƒãƒ¼ãƒ ã«ç·¨æˆã—ãªã„</option>
                    </select>
                    <button type="button" class="btn btn-danger" onclick="deleteFeedback({{ feedback.feedback_id }})">ğŸ—‘ï¸</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </table>

    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ -->
    <button class="add-feedback" type="button" onclick="addFeedbackRow()">ï¼‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¿½åŠ </button>
    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <button class="btn-save" type="button" onclick="saveFeedback()">ä¿å­˜</button>
</div>

<script>
    // ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateMembers(selectElement) {
        const form = selectElement.closest('form');
        const member1 = form.querySelector('select[name="member1"]').value;
        const member2 = form.querySelector('select[name="member2"]').value;

        if (member1 === member2) {
            alert('åŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚');
            selectElement.value = '';
        }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤ã™ã‚‹
    function deleteFeedback(feedbackId) {
        fetch("{% url 'canri_app:delete_feedback' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ feedback_id: feedbackId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        })
        .catch(error => console.error('Error deleting feedback:', error));
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
