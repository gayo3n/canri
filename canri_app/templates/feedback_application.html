{% load static %} 

{% block head %} 
<link rel="stylesheet" href="{% static 'css/feedback_application.css' %}">
{% endblock %}

{% block content %}

<div class="feedback-form">
    <h2>フィードバックの反映</h2>
    <table border="1">
        <!-- フィードバックコンテナ -->
        <div id="feedback-container">
            {% for feedback in feedbacks %}
            <!-- 初期フィードバック行 -->
            <div class="feedback-row">
                <form method="post" class="feedback-form">
                    {% csrf_token %}
                    <select name="member1" title="member1" onchange="validateMembers(this)">
                        {% for member in members %}
                        <option value="{{ member.member_id }}" {% if member.member_id == feedback.member1_id %}selected{% endif %}>{{ member.name }}</option>
                        {% endfor %}
                    </select>
                    と
                    <select name="member2" title="member2" onchange="validateMembers(this)">
                        {% for member in members %}
                        <option value="{{ member.member_id }}" {% if member.member_id == feedback.member2_id %}selected{% endif %}>{{ member.name }}</option>
                        {% endfor %}
                    </select>
                    を
                    <select name="priority" title="condition:">
                        <option value="1" {% if feedback.priority_flag %}selected{% endif %}>優先的に同じチームに編成する</option>
                        <option value="2" {% if not feedback.priority_flag %}selected{% endif %}>同じチームに編成しない</option>
                    </select>
                    <button type="button" class="btn btn-danger" onclick="deleteFeedback({{ feedback.feedback_id }})">🗑️</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </table>

    <!-- フィードバック追加ボタン -->
    <button class="add-feedback" type="button" onclick="addFeedbackRow()">＋ フィードバックを追加</button>
    <!-- 保存ボタン -->
    <button class="btn-save" type="button" onclick="saveFeedback()">保存</button>
</div>

<script>
    // メンバー選択のバリデーション
    function validateMembers(selectElement) {
        const form = selectElement.closest('form');
        const member1 = form.querySelector('select[name="member1"]').value;
        const member2 = form.querySelector('select[name="member2"]').value;

        if (member1 === member2) {
            alert('同じメンバーを選択することはできません。');
            selectElement.value = '';
        }
    }

    // フィードバックを保存する
    function saveFeedback() {
        const forms = document.querySelectorAll('.feedback-form');
        const formData = new FormData();
        forms.forEach((form, index) => {
            formData.append(`feedbacks[${index}][member1]`, form.querySelector('select[name="member1"]').value);
            formData.append(`feedbacks[${index}][member2]`, form.querySelector('select[name="member2"]').value);
            formData.append(`feedbacks[${index}][priority]`, form.querySelector('select[name="priority"]').value);
        });

        fetch("{% url 'canri_app:feedback_save' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            document.querySelector('.modal').style.display = 'none';
            document.getElementById('save-complete-body').innerHTML = html;
            document.getElementById('saveCompleteModal').style.display = 'block';
        })
        .catch(error => console.error('Error saving feedback:', error));
    }
</script>
{% endblock %}
